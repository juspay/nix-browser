name: "Static binary"
on:
  workflow_run:
    workflows: [CI]
    types: [completed]

jobs:
  on-success:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - run: echo 'The triggering workflow passed'
  on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - run: echo 'The triggering workflow failed'
  check:
    needs: on-success
    runs-on: ${{ matrix.system }}
    strategy:
      matrix:
        system: [ ubuntu-latest, macos-latest ]
    steps:
      - name: Donwload om static binary
        uses: actions/download-artifact@v4
        with:
          name: om-${{ matrix.system == 'ubuntu-latest' && 'x86_64-linux' || matrix.system == 'macos-latest' && 'aarch64-darwin' || matrix.system }}
      - name: Check nix installation
        run: |
          if which nix; then
            echo "nix is installed, exiting"
            exit 1
          elif test -d /nix; then
            echo "/nix is present, exiting"
            exit 1
          else
            echo "nix is not installed"
          fi
      - name: Run om static binary
        run: |
          chmod +x ./om
          ./om --help
